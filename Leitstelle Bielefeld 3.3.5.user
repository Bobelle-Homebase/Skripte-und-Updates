// ==UserScript==
// @name         Leitstelle Bielefeld
// @namespace    http://tampermonkey.net/
// @author       Bobelle©️
// @version      3.3.5
// @description  Saubere Icons, robuster Funk-Monitor und reparierter KTW-Zähler.
// @icon         https://www.leitstellenspiel.de/favicon.ico
// @match        https://www.leitstellenspiel.de/*
// @match        https://leitstellenspiel.de/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    // ---------- 1. KONFIGURATION ----------
    const isStartseite = (window.location.pathname === "/" || window.location.pathname === "" || window.location.pathname === "/leitstellenansicht");

    const CONFIG = {
        baseY: 220, // Höhe von oben
        posX: 11, // Abstand von Links
        keys: {
            ktw: 'c_ktw', ktwb: 'c_ktwb', nef: 'c_nef', naw: 'c_naw',
            irtw: 'c_irtw', rth: 'c_rth', lna: 'c_lna', orgl: 'c_orgl',
            grtw: 'c_grtw', pheli: 'c_pheli', drone: 'c_drone', manv: 'c_manv'
        }
    };

    // ---------- 2. TAGES-RESET ----------
    const today = new Date().toDateString();
    if (GM_getValue('last_reset_date', '') !== today) {
        Object.values(CONFIG.keys).forEach(k => GM_setValue(k, 0));
        GM_setValue('last_reset_date', today);
    }

    // ---------- 3. FUNK-LOGIK (NETZWERK) ----------
    let lastNetworkActivity = 0;
    const triggerFunk = () => { lastNetworkActivity = Date.now(); };

    const originalOpen = window.XMLHttpRequest.prototype.open;
    window.XMLHttpRequest.prototype.open = function() {
        this.addEventListener('loadstart', triggerFunk);
        return originalOpen.apply(this, arguments);
    };

    // ---------- 4. ZÄHL-FUNKTION ----------
    function increment(key) {
        let val = parseInt(GM_getValue(key, 0), 10);
        GM_setValue(key, (isNaN(val) ? 0 : val) + 1);

        // Live-Update der Anzeige, wenn man auf der Startseite ist
        const uiKey = Object.keys(CONFIG.keys).find(k => CONFIG.keys[k] === key);
        const el = document.getElementById(`lss-v-${uiKey}`);
        if (el) el.innerText = val + 1;
    }

    // ---------- 5. GLOBALER CLICK-LISTENER (ÜBERALL AKTIV) ----------
    document.addEventListener('mousedown', (e) => {
        const aao = e.target.closest('.aao');
        if (aao) {
            const t = aao.innerText || "";

            // WICHTIG: Reihenfolge beachten (Spezifisches vor Allgemeinem)
            if (t.includes("KTW-B") || t.includes("Typ B")) increment(CONFIG.keys.ktwb);

            // NEU: KTW Erkennung in der AAO (fixiert das Problem)
            else if (t.includes("KTW")) increment(CONFIG.keys.ktw);

            else if (t.includes("NEF")) increment(CONFIG.keys.nef);
            else if (t.includes("NAW")) increment(CONFIG.keys.naw);
            else if (t.includes("IRTW") || t.includes("ITW")) increment(CONFIG.keys.irtw);
            else if (t.includes("RTH") || t.includes("Christoph")) increment(CONFIG.keys.rth);
            else if (t.includes("KdoW-LNA") || t.includes("LNA")) increment(CONFIG.keys.lna);
            else if (t.includes("KdoW-OrgL") || t.includes("OrgL")) increment(CONFIG.keys.orgl);
            else if (t.includes("GRTW")) increment(CONFIG.keys.grtw);
            else if (t.includes("PHeli") || t.includes("Libelle") || t.includes("Polizeihelikopter")) increment(CONFIG.keys.pheli);
            else if (t.includes("Drohne") || t.includes("Drone") || t.includes("UAS")) increment(CONFIG.keys.drone);
            else if (t.includes("Manv") || t.includes("KatS") || t.includes("SEG")) increment(CONFIG.keys.manv);
        }
    }, true);

    // ---------- 6. GUI (NUR STARTSEITE) ----------
    if (isStartseite) {
        GM_addStyle(`
            .lss-btn {
                position: fixed; left: ${CONFIG.posX}px; width: 34px; height: 34px;
                background: white; border: 2px solid #333; border-radius: 5px;
                display: flex; justify-content: center; align-items: center;
                cursor: pointer; z-index: 9999;
                box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
                transition: transform 0.1s;
            }
            .lss-btn:active { transform: scale(0.95); }
            .lss-inner { display: flex; flex-direction: column; align-items: center; line-height: 0.9; text-align: center; width: 100%; pointer-events: none; }
            .lss-lbl { font-size: 8px; font-weight: bold; color: #333; margin-bottom: 1px; text-transform: uppercase; }
            .lss-val { font-size: 14px; font-weight: 800; font-family: sans-serif; }

            #wifi-icon { fill: #333; transition: fill 0.2s; }
            .funk-active #wifi-icon { fill: #e74c3c !important; }
            .funk-active { border-color: #e74c3c !important; animation: lss-blink 0.6s ease-in-out infinite alternate; }
            @keyframes lss-blink { from { box-shadow: 0 0 2px red; } to { box-shadow: 0 0 8px red; } }
        `);

        const BUTTONS = [
            // --- LINKS ---
            { id: "geb", title: "GEB", type: "link", url: "/buildings/26017007",
              svg: '<rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="9" y1="22" x2="9" y2="2"></line>' },
            { id: "ls", title: "LS", type: "link", url: "/leitstellenansicht",
              svg: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>' },
            { id: "sch", title: "SCH", type: "link", url: "/buildings/26017007#tab_schooling",
              svg: '<path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path>' },

            // --- HIER: Forum Button direkt über dem KTW ---
            { id: "forum", title: "Forum", type: "link", url: "https://forum.leitstellenspiel.de/",
              svg: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>' },

            // --- ZÄHLER ---
            { id: "ktw", title: "KTW", type: "cnt", color: "#27ae60" },
            { id: "ktwb", title: "KTW-B", type: "cnt", color: "#d35400" },
            { id: "nef", title: "NEF", type: "cnt", color: "#c0392b" },
            { id: "naw", title: "NAW", type: "cnt", color: "#2980b9" },
            { id: "irtw", title: "IRTW", type: "cnt", color: "#8e44ad" },
            { id: "rth", title: "RTH", type: "cnt", color: "#f1c40f" },
            { id: "lna", title: "LNA", type: "cnt", color: "#c0392b" },
            { id: "orgl", title: "OrgL", type: "cnt", color: "#16a085" },
            { id: "grtw", title: "GRTW", type: "cnt", color: "#2c3e50" },
            { id: "pheli", title: "PHeli", type: "cnt", color: "#1abc9c" },
            { id: "drone", title: "Drone", type: "cnt", color: "#7f8c8d" },
            { id: "manv", title: "MANV", type: "cnt", color: "#e84393" },
            { id: "funk", title: "Funk", type: "funk" }
        ];

        BUTTONS.forEach((btn, i) => {
            const div = document.createElement('div');
            div.id = `lss-btn-${btn.id}`;
            div.className = "lss-btn";
            div.style.top = `${CONFIG.baseY + (i * 38)}px`;
            div.title = btn.title;

            if (btn.type === "link") {
                div.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${btn.svg}</svg>`;
                div.addEventListener('click', () => window.open(btn.url, "_blank"));
            }
            else if (btn.type === "cnt") {
                const val = GM_getValue(CONFIG.keys[btn.id], 0);
                div.innerHTML = `<div class="lss-inner"><span class="lss-lbl">${btn.title}</span><span id="lss-v-${btn.id}" class="lss-val" style="color:${btn.color || 'black'}">${val}</span></div>`;
            }
            else if (btn.type === "funk") {
                div.innerHTML = `<div class="lss-inner"><span class="lss-lbl">Funk</span><svg id="wifi-icon" width="16" height="16" viewBox="0 0 24 24"><path d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0"/><circle cx="12" cy="20" r="2"/></svg></div>`;
            }
            document.body.appendChild(div);
        });

        setInterval(() => {
            const f = document.getElementById('lss-btn-funk');
            if (f) {
                if (Date.now() - lastNetworkActivity < 800) f.classList.add('funk-active');
                else f.classList.remove('funk-active');
            }

            // Backup-Update loop (falls EventListener mal verschluckt wurde)
            Object.keys(CONFIG.keys).forEach(k => {
                const el = document.getElementById(`lss-v-${k}`);
                if (el && el.innerText !== String(GM_getValue(CONFIG.keys[k], 0))) {
                    el.innerText = GM_getValue(CONFIG.keys[k], 0);
                }
            });
        }, 500);
    }
})();